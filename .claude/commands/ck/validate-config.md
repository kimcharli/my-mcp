---
command: "/ck:validate-config"
category: "Configuration & Validation"
purpose: "Comprehensive configuration validation and environment setup verification"
description: "Validate all configuration files, environment variables, and project setup for consistency and completeness"
allowed-tools: Bash(find:*), Bash(cat:*), Bash(node:*), Bash(python:*), Read(*), Grep(*), Glob(*)
wave-enabled: true
performance-profile: "standard"
agent: "bug-fixer"
---

## Context

- Project configuration files: !`find . -maxdepth 2 -name "*.json" -o -name "*.yaml" -o -name "*.yml" -o -name "*.toml"`
- Environment files: !`find . -name ".env*" -o -name "config.*"`
- Package files: @package.json @pyproject.toml @Cargo.toml @go.mod
- MCP configuration: @mcp.json @apify.json
- Current directory: !`pwd`
- Git status: !`git status --porcelain`

## Task

**Perform comprehensive validation of all project configuration files, environment setup, and dependencies.**

## Configuration Validation Workflow

### Phase 1: Configuration File Discovery & Analysis

#### File Discovery:
```bash
echo "=== Configuration File Discovery ==="

# Find all configuration files
find . -maxdepth 3 \( -name "*.json" -o -name "*.yaml" -o -name "*.yml" -o -name "*.toml" -o -name "*.ini" \) -type f | while read file; do
    echo "üìÑ Config file: $file"
    # Check file size and modification time
    ls -lh "$file" | awk '{print "   Size: " $5 ", Modified: " $6 " " $7 " " $8}'
done

# Find environment files
find . -name ".env*" -type f | while read file; do
    echo "üîê Environment file: $file"
done

# Find package configuration
find . -maxdepth 2 \( -name "package.json" -o -name "pyproject.toml" -o -name "Cargo.toml" -o -name "go.mod" -o -name "composer.json" \) | while read file; do
    echo "üì¶ Package config: $file"
done
```

### Phase 2: JSON/YAML Syntax Validation

#### Syntax Validation:
```bash
echo "=== Configuration Syntax Validation ==="

# Validate JSON files
find . -name "*.json" -type f | while read file; do
    echo "üîç Validating JSON: $file"
    if ! python -m json.tool "$file" > /dev/null 2>&1; then
        echo "‚ùå Invalid JSON syntax in $file"
        python -m json.tool "$file" 2>&1 | head -3
    else
        echo "‚úÖ Valid JSON: $file"
    fi
done

# Validate YAML files
find . \( -name "*.yaml" -o -name "*.yml" \) -type f | while read file; do
    echo "üîç Validating YAML: $file"
    if command -v python >/dev/null 2>&1; then
        python -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null
        if [ $? -eq 0 ]; then
            echo "‚úÖ Valid YAML: $file"
        else
            echo "‚ùå Invalid YAML syntax in $file"
        fi
    else
        echo "‚ö†Ô∏è Python not available for YAML validation"
    fi
done

# Validate TOML files
find . -name "*.toml" -type f | while read file; do
    echo "üîç Validating TOML: $file"
    if command -v python >/dev/null 2>&1; then
        python -c "import tomllib; tomllib.load(open('$file', 'rb'))" 2>/dev/null
        if [ $? -eq 0 ]; then
            echo "‚úÖ Valid TOML: $file"
        else
            echo "‚ùå Invalid TOML syntax in $file"
        fi
    else
        echo "‚ö†Ô∏è Python tomllib not available for TOML validation"
    fi
done
```

### Phase 3: MCP Configuration Validation

#### MCP Server Configuration:
```bash
echo "=== MCP Configuration Validation ==="

# Validate mcp.json structure
if [ -f "mcp.json" ]; then
    echo "üîç Validating MCP configuration..."
    
    # Check required structure
    python -c "
import json
try:
    with open('mcp.json') as f:
        config = json.load(f)
    
    if 'mcpServers' not in config:
        print('‚ùå Missing mcpServers section in mcp.json')
    else:
        servers = config['mcpServers']
        print(f'‚úÖ Found {len(servers)} MCP servers configured')
        
        for name, server_config in servers.items():
            print(f'üì° Server: {name}')
            if 'command' not in server_config:
                print(f'   ‚ùå Missing command for server {name}')
            else:
                print(f'   ‚úÖ Command: {server_config[\"command\"]}')
            
            if 'args' in server_config:
                print(f'   ‚úÖ Args: {len(server_config[\"args\"])} arguments')
            
            if 'env' in server_config:
                print(f'   üîê Environment variables: {len(server_config[\"env\"])}')

except Exception as e:
    print(f'‚ùå Error validating mcp.json: {e}')
" 2>/dev/null || echo "‚ö†Ô∏è Could not validate mcp.json"
else
    echo "‚ö†Ô∏è No mcp.json found"
fi

# Validate apify.json if present
if [ -f "apify.json" ]; then
    echo "üîç Validating Apify configuration..."
    python -m json.tool apify.json > /dev/null 2>&1 && echo "‚úÖ Valid apify.json" || echo "‚ùå Invalid apify.json"
fi
```

### Phase 4: Package Configuration Validation

#### Node.js Package Validation:
```bash
if [ -f "package.json" ]; then
    echo "=== Node.js Package Validation ==="
    
    # Check package.json structure
    echo "üîç Validating package.json structure..."
    node -e "
    const pkg = require('./package.json');
    console.log('‚úÖ Package name:', pkg.name || 'Not specified');
    console.log('‚úÖ Version:', pkg.version || 'Not specified');
    console.log('‚úÖ Dependencies:', Object.keys(pkg.dependencies || {}).length);
    console.log('‚úÖ DevDependencies:', Object.keys(pkg.devDependencies || {}).length);
    console.log('‚úÖ Scripts:', Object.keys(pkg.scripts || {}).length);
    
    // Check for common required scripts
    const scripts = pkg.scripts || {};
    const recommendedScripts = ['start', 'test', 'build', 'lint'];
    recommendedScripts.forEach(script => {
        if (scripts[script]) {
            console.log('‚úÖ Script found:', script);
        } else {
            console.log('‚ö†Ô∏è Recommended script missing:', script);
        }
    });
    " 2>/dev/null || echo "‚ùå Could not validate package.json"
    
    # Check for package-lock.json or yarn.lock
    if [ -f "package-lock.json" ]; then
        echo "‚úÖ package-lock.json found (npm)"
    elif [ -f "yarn.lock" ]; then
        echo "‚úÖ yarn.lock found (yarn)"
    else
        echo "‚ö†Ô∏è No lock file found (package-lock.json or yarn.lock)"
    fi
fi
```

#### Python Package Validation:
```bash
if [ -f "pyproject.toml" ]; then
    echo "=== Python Package Validation ==="
    
    echo "üîç Validating pyproject.toml structure..."
    python -c "
import tomllib
try:
    with open('pyproject.toml', 'rb') as f:
        config = tomllib.load(f)
    
    if 'project' in config:
        project = config['project']
        print('‚úÖ Project name:', project.get('name', 'Not specified'))
        print('‚úÖ Version:', project.get('version', 'Not specified'))
        print('‚úÖ Dependencies:', len(project.get('dependencies', [])))
        
        if 'optional-dependencies' in project:
            opt_deps = project['optional-dependencies']
            for group, deps in opt_deps.items():
                print(f'‚úÖ Optional dependencies ({group}):', len(deps))
    
    if 'build-system' in config:
        print('‚úÖ Build system configured')
    else:
        print('‚ö†Ô∏è No build-system specified')
        
    if 'tool' in config:
        tools = config['tool']
        for tool in ['black', 'pytest', 'mypy', 'ruff']:
            if tool in tools:
                print(f'‚úÖ Tool configured: {tool}')

except Exception as e:
    print(f'‚ùå Error validating pyproject.toml: {e}')
" 2>/dev/null || echo "‚ùå Could not validate pyproject.toml"
    
    # Check for UV lock file
    if [ -f "uv.lock" ]; then
        echo "‚úÖ uv.lock found"
    else
        echo "‚ö†Ô∏è No uv.lock found"
    fi
fi
```

### Phase 5: Environment Variable Validation

#### Environment Configuration:
```bash
echo "=== Environment Configuration Validation ==="

# Check for environment files
if [ -f ".env" ]; then
    echo "üîê Found .env file"
    echo "   ‚ö†Ô∏è Warning: .env files should not be committed to git"
    
    # Check if .env is in .gitignore
    if [ -f ".gitignore" ] && grep -q "\.env" .gitignore; then
        echo "   ‚úÖ .env is in .gitignore"
    else
        echo "   ‚ùå .env should be added to .gitignore"
    fi
fi

if [ -f ".env.example" ]; then
    echo "‚úÖ Found .env.example template"
    
    # Compare .env and .env.example if both exist
    if [ -f ".env" ]; then
        echo "üîç Comparing .env with .env.example..."
        
        # Extract variable names (ignore comments and empty lines)
        env_vars=$(grep -E '^[A-Z_]+=.*' .env 2>/dev/null | cut -d= -f1 | sort)
        example_vars=$(grep -E '^[A-Z_]+=.*' .env.example 2>/dev/null | cut -d= -f1 | sort)
        
        # Check for missing variables
        for var in $example_vars; do
            if ! echo "$env_vars" | grep -q "^$var$"; then
                echo "   ‚ö†Ô∏è Variable $var missing from .env"
            fi
        done
        
        # Check for extra variables
        for var in $env_vars; do
            if ! echo "$example_vars" | grep -q "^$var$"; then
                echo "   ‚ÑπÔ∏è Extra variable $var in .env (not in example)"
            fi
        done
    fi
else
    echo "‚ö†Ô∏è No .env.example template found"
fi

# Check for environment variables in current shell
echo "üîç Checking critical environment variables..."
critical_vars="NODE_ENV PYTHON_PATH PATH"
for var in $critical_vars; do
    if [ -n "${!var}" ]; then
        echo "‚úÖ $var is set"
    else
        echo "‚ö†Ô∏è $var is not set"
    fi
done
```

### Phase 6: Dependency and Version Validation

#### Dependency Validation:
```bash
echo "=== Dependency Validation ==="

# Node.js dependencies
if [ -f "package.json" ]; then
    echo "üîç Checking Node.js dependencies..."
    
    # Check for npm audit
    if command -v npm >/dev/null 2>&1; then
        echo "üîí Running npm audit..."
        npm audit --audit-level=high 2>/dev/null | head -10 || echo "‚ö†Ô∏è npm audit check completed"
    fi
    
    # Check for outdated packages
    if command -v npm >/dev/null 2>&1; then
        echo "üì¶ Checking for outdated packages..."
        npm outdated 2>/dev/null | head -5 || echo "‚úÖ Package versions checked"
    fi
fi

# Python dependencies
if [ -f "pyproject.toml" ]; then
    echo "üîç Checking Python dependencies..."
    
    # Check for safety (security audit)
    if command -v safety >/dev/null 2>&1; then
        echo "üîí Running safety check..."
        safety check 2>/dev/null | head -5 || echo "‚ö†Ô∏è Safety check completed"
    fi
    
    # Check UV sync status
    if command -v uv >/dev/null 2>&1; then
        echo "üì¶ Checking UV sync status..."
        uv sync --dry-run 2>/dev/null | head -3 || echo "‚úÖ UV dependencies checked"
    fi
fi
```

### Phase 7: File Permissions and Security

#### Security Validation:
```bash
echo "=== Security and Permissions Validation ==="

# Check file permissions on config files
echo "üîí Checking configuration file permissions..."
find . -name "*.json" -o -name "*.yaml" -o -name "*.yml" -o -name "*.toml" | while read file; do
    perms=$(ls -l "$file" | cut -d' ' -f1)
    if [[ "$perms" == *"w"*"w"* ]]; then
        echo "‚ö†Ô∏è $file is world-writable ($perms)"
    else
        echo "‚úÖ $file has appropriate permissions ($perms)"
    fi
done

# Check for sensitive data in config files
echo "üîç Scanning for potential sensitive data..."
find . -name "*.json" -o -name "*.yaml" -o -name "*.yml" | xargs grep -iE "password|secret|key|token" 2>/dev/null | while read match; do
    echo "‚ö†Ô∏è Potential sensitive data: $match"
done

# Check .gitignore coverage
if [ -f ".gitignore" ]; then
    echo "‚úÖ .gitignore found"
    
    # Check for common patterns
    patterns=("node_modules" "*.log" ".env" "__pycache__" "*.pyc" "target/" "dist/")
    for pattern in "${patterns[@]}"; do
        if grep -q "$pattern" .gitignore; then
            echo "‚úÖ .gitignore includes: $pattern"
        else
            echo "‚ö†Ô∏è Consider adding to .gitignore: $pattern"
        fi
    done
else
    echo "‚ùå No .gitignore found"
fi
```

## Validation Report Generation

### Summary Report:
```bash
generate_validation_report() {
    echo "=== Configuration Validation Summary ==="
    echo "Generated on: $(date)"
    echo "Project: $(basename $(pwd))"
    echo ""
    
    # Count files validated
    config_files=$(find . -maxdepth 3 \( -name "*.json" -o -name "*.yaml" -o -name "*.yml" -o -name "*.toml" \) | wc -l)
    env_files=$(find . -name ".env*" | wc -l)
    
    echo "üìä Files Validated:"
    echo "   - Configuration files: $config_files"
    echo "   - Environment files: $env_files"
    echo "   - Package files: $(find . -maxdepth 2 \( -name "package.json" -o -name "pyproject.toml" \) | wc -l)"
    echo ""
    
    echo "üéØ Validation Categories:"
    echo "   ‚úÖ Syntax validation completed"
    echo "   ‚úÖ MCP configuration checked"
    echo "   ‚úÖ Package configuration validated"
    echo "   ‚úÖ Environment setup verified"
    echo "   ‚úÖ Dependencies analyzed"
    echo "   ‚úÖ Security permissions checked"
    echo ""
    
    echo "üí° Recommendations:"
    echo "   - Review any ‚ö†Ô∏è warnings above"
    echo "   - Ensure sensitive data is not committed"
    echo "   - Keep dependencies updated and secure"
    echo "   - Validate changes after configuration updates"
}
```

## Quick Fix Suggestions

### Common Issues and Fixes:
```bash
# Fix common configuration issues
echo "=== Quick Fix Suggestions ==="

# Missing .gitignore entries
if [ -f ".gitignore" ]; then
    if ! grep -q "node_modules" .gitignore 2>/dev/null; then
        echo "üí° Add to .gitignore: node_modules/"
    fi
    if ! grep -q "\.env$" .gitignore 2>/dev/null; then
        echo "üí° Add to .gitignore: .env"
    fi
    if ! grep -q "__pycache__" .gitignore 2>/dev/null; then
        echo "üí° Add to .gitignore: __pycache__/"
    fi
fi

# Package.json improvements
if [ -f "package.json" ]; then
    if ! grep -q '"engines"' package.json; then
        echo "üí° Consider adding engines field to package.json"
    fi
    if ! grep -q '"repository"' package.json; then
        echo "üí° Consider adding repository field to package.json"
    fi
fi

# Environment template
if [ -f ".env" ] && [ ! -f ".env.example" ]; then
    echo "üí° Create .env.example template from .env (without sensitive values)"
fi
```

## Success Criteria

### Validation Completeness:
- ‚úÖ **All Config Files Found**: Discovered and analyzed all configuration files
- ‚úÖ **Syntax Validation**: All JSON/YAML/TOML files have valid syntax
- ‚úÖ **MCP Configuration**: MCP servers properly configured and validated
- ‚úÖ **Package Configuration**: Node.js/Python packages properly structured
- ‚úÖ **Environment Setup**: Environment variables properly configured
- ‚úÖ **Security Check**: No sensitive data in committed files
- ‚úÖ **Dependencies**: All dependencies valid and secure

### Quality Standards:
- ‚úÖ **No Syntax Errors**: All configuration files parse correctly
- ‚úÖ **Complete Coverage**: All required configuration present
- ‚úÖ **Security Compliance**: Sensitive data properly handled
- ‚úÖ **Dependency Health**: No critical security vulnerabilities
- ‚úÖ **File Permissions**: Appropriate permissions on all files
- ‚úÖ **Documentation**: Configuration properly documented
